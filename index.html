<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Object 1 Developer: 3-Year Market Performance</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'object1-primary': '#4f46e5', // Indigo
                        'object1-secondary': '#f97316', // Orange
                        'object1-success': '#10b981', // Emerald for growth
                    }
                }
            }
        }
    </script>
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        
        .chart-container {
            position: relative;
            height: 400px; /* Fixed height for consistent chart display */
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans p-4 md:p-8">

    <div id="app-container" class="max-w-7xl mx-auto">

        <!-- Header -->
        <header class="text-center mb-12 p-8 bg-white rounded-2xl shadow-2xl border-b-4 border-object1-primary">
            <h1 class="text-4xl md:text-6xl font-extrabold text-gray-900 mb-3 leading-tight">
                <span class="text-object1-primary">Object 1 Developer</span>
            </h1>
            <p class="text-xl text-gray-700 font-medium">Strategic Performance & Developer Benchmarking (2023 - 2025)</p>
            <p class="mt-6 text-xl font-semibold text-object1-secondary border-t pt-4">Presented by: Basem Al Salahi - Sales Manager</p>
        </header>

        <!-- Object 1 Spotlight - Key Performance Snapshot (2025 vs 2024) -->
        <section class="mb-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 pb-3 text-center md:text-left">
                <span class="text-object1-secondary">üöÄ</span> Momentum Snapshot: Exponential Growth (2025 vs 2024)
            </h2>
            <div id="snapshot-cards" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6">
                <!-- Cards will be populated and calculated by JS -->
                
                <!-- 1. Total Sales Value -->
                <div class="bg-white p-6 rounded-xl shadow-lg border-b-4 border-object1-primary hover:scale-[1.03] transition duration-300 transform">
                    <p class="text-sm font-medium text-gray-500">Total Sales Value</p>
                    <p id="snapshot-SalesValue-value" class="text-2xl md:text-4xl font-bold text-object1-primary">Loading...</p>
                    <div class="flex items-center mt-2">
                        <span id="snapshot-SalesValue-change" class="text-xs md:text-base font-semibold text-green-600 mr-1 flex items-center">
                            <!-- Calculated: +170.01% -->
                        </span>
                        <span id="snapshot-SalesValue-context" class="text-xs text-gray-500 hidden md:inline"></span>
                    </div>
                </div>
                
                <!-- 2. Sales Volume (Oqood) -->
                <div class="bg-white p-6 rounded-xl shadow-lg border-b-4 border-object1-secondary hover:scale-[1.03] transition duration-300 transform">
                    <p class="text-sm font-medium text-gray-500">Sales Volume (Oqood)</p>
                    <p id="snapshot-Volume-value" class="text-2xl md:text-4xl font-bold text-object1-secondary">Loading...</p>
                    <div class="flex items-center mt-2">
                        <span id="snapshot-Volume-change" class="text-xs md:text-base font-semibold text-green-600 mr-1 flex items-center">
                            <!-- Calculated: +121.85% -->
                        </span>
                        <span id="snapshot-Volume-context" class="text-xs text-gray-500 hidden md:inline"></span>
                    </div>
                </div>

                <!-- 3. Total Built-up Area -->
                <div class="bg-white p-6 rounded-xl shadow-lg border-b-4 border-purple-500 hover:scale-[1.03] transition duration-300 transform">
                    <p class="text-sm font-medium text-gray-500">Total Built-up Area</p>
                    <p id="snapshot-BuiltUpArea-value" class="text-2xl md:text-4xl font-bold text-purple-600">Loading...</p>
                    <div class="flex items-center mt-2">
                        <span id="snapshot-BuiltUpArea-change" class="text-xs md:text-base font-semibold text-green-600 mr-1 flex items-center">
                            <!-- Calculated: +118.91% -->
                        </span>
                        <span id="snapshot-BuiltUpArea-context" class="text-xs text-gray-500 hidden md:inline"></span>
                    </div>
                </div>
                
                <!-- 4. Total Sales Rank -->
                <div class="bg-white p-6 rounded-xl shadow-lg border-b-4 border-object1-success hover:scale-[1.03] transition duration-300 transform">
                    <p class="text-sm font-medium text-gray-500">Total Sales Rank</p>
                    <p id="snapshot-SalesRank-value" class="text-2xl md:text-4xl font-bold text-object1-success">Loading...</p>
                    <div class="flex items-center mt-2">
                        <span id="snapshot-SalesRank-change" class="text-xs md:text-base font-semibold text-green-600 mr-1 flex items-center">
                            <!-- Calculated: Improved by 7 -->
                        </span>
                        <span id="snapshot-SalesRank-context" class="text-xs text-gray-500 hidden md:inline"></span>
                    </div>
                </div>
                
                <!-- 5. Avg. Price per Sq Ft -->
                <div class="bg-white p-6 rounded-xl shadow-lg border-b-4 border-pink-500 hover:scale-[1.03] transition duration-300 transform">
                    <p class="text-sm font-medium text-gray-500">Avg. Price per Sq Ft</p>
                    <p id="snapshot-AvgPriceSqFt-value" class="text-2xl md:text-4xl font-bold text-pink-600">Loading...</p>
                    <div class="flex items-center mt-2">
                        <span id="snapshot-AvgPriceSqFt-change" class="text-xs md:text-base font-semibold text-green-600 mr-1 flex items-center">
                            <!-- Calculated: +23.94% -->
                        </span>
                        <span id="snapshot-AvgPriceSqFt-context" class="text-xs text-gray-500 hidden md:inline"></span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section: Sales Value Growth Chart (Year-over-Year) -->
        <section class="mb-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 pb-3 text-center md:text-left">
                <span class="text-object1-primary">üìà</span> Chart 1: Total Sales Value (AED Billion) 2023-2025
            </h2>
            <div class="bg-white p-6 rounded-2xl shadow-2xl">
                <div class="chart-container h-96">
                    <canvas id="salesValueChart"></canvas>
                </div>
                <p class="text-sm text-gray-600 mt-4 text-center">Visualizing the massive year-over-year increase in total sales value.</p>
            </div>
        </section>
        
        <!-- UPDATED SECTION: Market Share Among Top Developers (After Chart 1) -->
        <section class="mb-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 pb-3 text-center md:text-left">
                <span class="text-object1-secondary">üèÜ</span> Market Share Snapshot: Top 20 Developers
            </h2>
            <div class="bg-white p-6 rounded-2xl shadow-2xl">
                <!-- Changed to h-96 and updated placeholder image dimensions (800x600 is less wide) -->
                <div class="w-full h-96 bg-gray-200 flex items-center justify-center rounded-xl border-4 border-dashed border-object1-primary/50 overflow-hidden">
                    <img 
                        src="https://placehold.co/800x600/4f46e5/ffffff?text=PLACEHOLDER+IMAGE%3A+Market+Share+Visual&font=Inter" 
                        alt="Market Share among 20 Developers" 
                        onerror="this.onerror=null; this.src='https://placehold.co/800x600/4f46e5/ffffff?text=Failed+to+Load+Market+Share+Image'" 
                        class="w-full h-full object-cover"
                    >
                </div>
                <p class="text-sm text-gray-600 mt-4 text-center font-medium">This visual highlights Object 1's growing market footprint against the top 20 established developers in Dubai.</p>
            </div>
        </section>

        <!-- Section: Sales Location Distribution Chart (Doughnut Chart) -->
        <section class="mb-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 pb-3 text-center md:text-left">
                <span class="text-object1-primary">üó∫Ô∏è</span> Chart 2: Object 1 Sales Distribution by Location (2025)
            </h2>
            <div class="bg-white p-6 rounded-2xl shadow-2xl">
                <!-- Added Flexbox for better centering of the Doughnut chart -->
                <div class="chart-container h-96 flex items-center justify-center"> 
                    <canvas id="locationSalesChart" class="max-w-full max-h-full"></canvas>
                </div>
                <p class="text-sm text-gray-600 mt-4 text-center">Visualizing the unit distribution across primary development areas. <span class="font-semibold text-object1-secondary">JVT and JVC dominate volume.</span></p>
            </div>
        </section>

        <!-- Location-Specific Performance Ranks (After Chart 2) -->
        <section class="mb-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 pb-3 text-center md:text-left">
                <span class="text-object1-primary">üéØ</span> Local Dominance: Rank by Unit Sales in Key Communities
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Image 1: JVT Rank -->
                <div class="bg-white p-6 rounded-2xl shadow-2xl">
                    <h3 class="text-xl font-bold text-gray-700 mb-4 flex items-center"><span class="text-3xl mr-2 text-object1-success">#3</span> Top Developer in JVT</h3>
                    <div class="w-full h-64 bg-gray-200 flex items-center justify-center rounded-xl overflow-hidden">
                        <img 
                            src="https://placehold.co/600x400/10b981/ffffff?text=JVT+RANK+%233+EVIDENCE&font=Inter" 
                            alt="Developer Rank #3 in JVT" 
                            onerror="this.onerror=null; this.src='https://placehold.co/600x400/10b981/ffffff?text=Failed+to+Load+JVT+Rank+Image'" 
                            class="w-full h-full object-cover"
                        >
                    </div>
                    <p class="text-sm text-gray-600 mt-4 text-center">Visual confirmation of Object 1's position as the third highest-selling developer by volume in Jumeirah Village Triangle.</p>
                </div>
                
                <!-- Image 2: JVC Rank -->
                <div class="bg-white p-6 rounded-2xl shadow-2xl">
                    <h3 class="text-xl font-bold text-gray-700 mb-4 flex items-center"><span class="text-3xl mr-2 text-object1-secondary">#6</span> Top Developer in JVC</h3>
                    <div class="w-full h-64 bg-gray-200 flex items-center justify-center rounded-xl overflow-hidden">
                        <img 
                            src="https://placehold.co/600x400/f97316/ffffff?text=JVC+RANK+%236+EVIDENCE&font=Inter" 
                            alt="Developer Rank #6 in JVC" 
                            class="w-full h-full object-cover"
                        >
                    </div>
                    <p class="text-sm text-gray-600 mt-4 text-center">Evidence confirming the sixth highest-selling developer by volume in the competitive Jumeirah Village Circle market.</p>
                </div>
            </div>
        </section>

        <!-- Chart 3: Market Positioning -->
        <section class="mb-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 pb-3 text-center md:text-left">
                <span class="text-object1-secondary">üìç</span> Chart 3: Market Positioning - Avg Price per Sq Ft (2025)
            </h2>
            <div class="bg-white p-6 rounded-2xl shadow-2xl">
                <div class="chart-container h-96">
                    <canvas id="avgPriceChart"></canvas>
                </div>
                <p class="text-sm text-gray-600 mt-4 text-center">Comparing Object 1's pricing strategy relative to key market developers.</p>
            </div>
        </section>
        
        <!-- Investor Appreciation / Resale Transactions (After Chart 3) -->
        <section class="mb-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 pb-3 text-center md:text-left">
                <span class="text-pink-500">üí∞</span> Resale Success: Documented Investor Appreciation
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <!-- Resale 1 -->
                <div class="bg-white p-4 rounded-xl shadow-lg border-t-4 border-pink-500">
                    <div class="w-full h-40 bg-gray-200 flex items-center justify-center rounded-lg overflow-hidden mb-3">
                        <img 
                            src="https://placehold.co/300x200/db2777/ffffff?text=RESALE+1+15%25+GAIN&font=Inter" 
                            alt="Resale Transaction 1" 
                            class="w-full h-full object-cover"
                        >
                    </div>
                    <p class="text-lg font-bold text-pink-600">Transaction 1</p>
                    <p class="text-sm text-gray-700 font-medium">Gain: 15% in 8 months</p>
                </div>
                <!-- Resale 2 -->
                <div class="bg-white p-4 rounded-xl shadow-lg border-t-4 border-pink-500">
                    <div class="w-full h-40 bg-gray-200 flex items-center justify-center rounded-lg overflow-hidden mb-3">
                        <img 
                            src="https://placehold.co/300x200/db2777/ffffff?text=RESALE+2+18%25+GAIN&font=Inter" 
                            alt="Resale Transaction 2" 
                            class="w-full h-full object-cover"
                        >
                    </div>
                    <p class="text-lg font-bold text-pink-600">Transaction 2</p>
                    <p class="text-sm text-gray-700 font-medium">Gain: 18% in 10 months</p>
                </div>
                <!-- Resale 3 -->
                <div class="bg-white p-4 rounded-xl shadow-lg border-t-4 border-pink-500">
                    <div class="w-full h-40 bg-gray-200 flex items-center justify-center rounded-lg overflow-hidden mb-3">
                        <img 
                            src="https://placehold.co/300x200/db2777/ffffff?text=RESALE+3+21%25+GAIN&font=Inter" 
                            alt="Resale Transaction 3" 
                            class="w-full h-full object-cover"
                        >
                    </div>
                    <p class="text-lg font-bold text-pink-600">Transaction 3</p>
                    <p class="text-sm text-gray-700 font-medium">Gain: 21% in 12 months</p>
                </div>
                <!-- Resale 4 -->
                <div class="bg-white p-4 rounded-xl shadow-lg border-t-4 border-pink-500">
                    <div class="w-full h-40 bg-gray-200 flex items-center justify-center rounded-lg overflow-hidden mb-3">
                        <img 
                            src="https://placehold.co/300x200/db2777/ffffff?text=RESALE+4+13%25+GAIN&font=Inter" 
                            alt="Resale Transaction 4" 
                            class="w-full h-full object-cover"
                        >
                    </div>
                    <p class="text-lg font-bold text-pink-600">Transaction 4</p>
                    <p class="text-sm text-gray-700 font-medium">Gain: 13% in 6 months</p>
                </div>
            </div>
            <p class="text-sm text-gray-600 mt-4 text-center">These transactions demonstrate the strong immediate appreciation potential for investors in Object 1 properties.</p>
        </section>

        <!-- Detailed Comparison Table (Now 3 years) -->
        <section class="mb-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 pb-3 text-center md:text-left">
                <span class="text-object1-primary">üìã</span> Object 1: Full 3-Year Metric Comparison (2023 - 2025)
            </h2>
            <div class="overflow-x-auto bg-white rounded-2xl shadow-2xl border">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-object1-primary/10">
                        <tr>
                            <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider w-1/4">Metric</th>
                            <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 uppercase tracking-wider">2023 Data</th>
                            <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 uppercase tracking-wider">2024 Data</th>
                            <th class="px-6 py-4 text-right text-sm font-bold text-object1-primary uppercase tracking-wider">2025 Data</th>
                            <th class="px-6 py-4 text-right text-sm font-bold text-gray-700 uppercase tracking-wider">Change (25 vs 24)</th>
                        </tr>
                    </thead>
                    <tbody id="comparisonTableBody" class="divide-y divide-gray-100">
                        <!-- Table content populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Footer / Source -->
        <footer class="text-center text-sm text-gray-500 py-6 border-t mt-12 bg-white rounded-xl shadow-inner">
            <!-- PRESENTATION INFO ADDED WITH ICONS -->
            <div class="mb-4 text-gray-800 font-medium">
                <p class="text-base font-semibold">Presented by: Basem Al Salahi - Sales Manager</p>
                <div class="mt-2 flex justify-center space-x-6 items-center">
                    
                    <!-- 1. Phone Icon (Contact) - NOW CLICKABLE -->
                    <p class="text-sm">
                        <!-- TEL link for phone number -->
                        <a href="tel:+971568722192" class="text-object1-primary font-bold inline-flex items-center hover:text-object1-secondary transition duration-150">
                            <!-- Phone Icon SVG (Lucide: Phone) -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 inline-block mr-1 align-middle"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 3.08 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                            +971568722192
                        </a>
                    </p>
                    
                    <!-- 2. Instagram Icon - NOW CLICKABLE -->
                    <p class="text-sm">
                        <!-- Anchor tag to Instagram profile -->
                        <a href="https://www.instagram.com/basemrealestatedxb/" target="_blank" rel="noopener noreferrer" class="text-object1-primary font-bold inline-flex items-center hover:text-object1-secondary transition duration-150">
                            <!-- Instagram Icon SVG -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 inline-block mr-1 align-middle"><rect width="20" height="20" x="2" y="2" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" x2="17.5" y1="6.5" y2="6.5"/></svg>
                            Instagram
                        </a>
                    </p>
                </div>
            </div>
            <p class="text-xs italic text-gray-400">Data Source: Property Monitor > Dubai Real Estate Developers Statistics (2023 - 2025).</p>
        </footer>
    </div>

    <script>
        /**
         * Helper function to format numbers for display in B/M (Billions/Millions).
         */
        const formatNumber = (value, isCurrency = false, isSqFt = false) => {
            if (value === null || value === undefined) return 'N/A';
            if (typeof value === 'string' && value.includes('N/A')) return value;

            const num = Number(value);
            if (isNaN(num)) return 'N/A';

            let formatted;
            let unit = '';
            
            if (isCurrency && num >= 1e9) {
                formatted = (num / 1e9).toFixed(2);
                unit = ' B';
            } else if (isCurrency && num >= 1e6) {
                formatted = (num / 1e6).toFixed(2);
                unit = ' M';
            } else if (isSqFt && num >= 1e6) {
                formatted = (num / 1e6).toFixed(2);
                unit = ' M';
            } else {
                // Default to a whole number with locale string if it's not a large number
                formatted = Math.round(num).toLocaleString();
            }

            if (isCurrency) {
                return `AED ${formatted}${unit}`;
            } else if (isSqFt) {
                return `${formatted}${unit} sq ft`;
            } else if (unit) {
                return `${formatted}${unit}`;
            }
            return formatted;
        };
        
        /**
         * Calculates percentage change.
         */
        const calculateChange = (current, previous) => {
            if (previous === 0 || previous === null || previous === undefined || isNaN(previous) || current === null || current === undefined || isNaN(current)) {
                return { value: 'N/A', percent: 'N/A' };
            }
            
            const diff = current - previous;
            if (previous === 0) return { value: diff.toLocaleString(), percent: 'N/A' };
            
            const percent = ((diff / previous) * 100).toFixed(2);
            return {
                value: diff.toLocaleString(),
                percent: `${diff > 0 ? '+' : ''}${percent}%`,
                isPositive: diff > 0
            };
        };

        // --- ENHANCED RAW DATA STRUCTURE ---
        const infographicData = {
          "years": [2023, 2024, 2025],
          "object1Metrics": {
                // Key: [2023 Value, 2024 Value, 2025 Value]
                "SalesValue": [17000000, 545298602, 1470325068],
                "Volume": [16, 627, 1391],
                "BuiltUpArea": [14123, 467846, 1024073],
                "SalesRank": [95, 33, 26], // Lower is better
                "VolumeRank": [96, 18, 16], // Lower is better
                "AvgPriceSqFt": [1260, 1203, 1491],
                // AvgPriceUnit is calculated on the fly: SalesValue / Volume
          },
          // NEW DATA: Sales distribution by location based on the uploaded CSV
          "locationSalesData": [
            { "location": "Jumeirah Village Triangle", "units": 595 },
            { "location": "Jumeirah Village Circle", "units": 336 },
            { "location": "Al Satwa", "units": 195 },
            { "location": "Dubai Residence Complex", "units": 135 },
            { "location": "Al Furjan", "units": 103 },
            { "location": "Dubai Sports City", "units": 27 },
          ],
          "developerComparisonData": [
            { "Name": "Emaar", "AvgPricePerSqFt2025": 2472 },
            { "Name": "Sobha Group", "AvgPricePerSqFt2025": 2304 },
            { "Name": "DAMAC Properties", "AvgPricePerSqFt2025": 1961 },
            { "Name": "Danube Properties", "AvgPricePerSqFt2025": 2274 },
            { "Name": "Binghatti", "AvgPricePerSqFt2025": 2084 },
            { "Name": "Samana Developers", "AvgPricePerSqFt2025": 1520 },
            { "Name": "Azizi", "AvgPricePerSqFt2025": 1700 },
            // Injecting Object 1 data dynamically for comparison
          ]
        };
        
        // Global chart instances to allow destruction on redraw
        let salesValueChartInstance;
        let locationSalesChartInstance;
        let avgPriceChartInstance;


        /**
         * Populates the snapshot cards with calculated 2025 vs 2024 data.
         */
        function populateSnapshotCards(data) {
            const metrics = data.object1Metrics;
            const y24 = 1; // Index for 2024
            const y25 = 2; // Index for 2025

            const cardsInfo = [
                { id: 'SalesValue', key: 'SalesValue', label: 'Total Sales Value', valueFormatter: (v) => formatNumber(v, true) },
                { id: 'Volume', key: 'Volume', label: 'Sales Volume (Oqood)', valueFormatter: (v) => formatNumber(v) + ' Units' },
                { id: 'BuiltUpArea', key: 'BuiltUpArea', label: 'Total Built-up Area', valueFormatter: (v) => formatNumber(v, false, true) },
                { id: 'SalesRank', key: 'SalesRank', label: 'Total Sales Rank', isRank: true, valueFormatter: (v) => `#${v}` },
                { id: 'AvgPriceSqFt', key: 'AvgPriceSqFt', label: 'Avg. Price per Sq Ft', valueFormatter: (v) => formatNumber(v, true) }
            ];

            cardsInfo.forEach(info => {
                const currentVal = metrics[info.key][y25];
                const prevVal = metrics[info.key][y24];
                
                const change = info.isRank
                    ? { percent: prevVal - currentVal, isPositive: (prevVal - currentVal) > 0 }
                    : calculateChange(currentVal, prevVal);

                const valueElement = document.getElementById(`snapshot-${info.id}-value`);
                const changeElement = document.getElementById(`snapshot-${info.id}-change`);
                const contextElement = document.getElementById(`snapshot-${info.id}-context`);

                if (valueElement) {
                    valueElement.textContent = info.valueFormatter(currentVal);
                }

                if (contextElement) {
                     // Determine context text based on metric type
                    let contextText;
                    if (info.key === 'SalesRank') {
                        contextText = `from #${prevVal} in 2024`;
                    } else if (info.key === 'BuiltUpArea') {
                        contextText = `vs 2024 (${formatNumber(prevVal, false, true)})`;
                    } else if (info.key === 'Volume') {
                         contextText = `vs 2024 (${formatNumber(prevVal)} Units)`;
                    }
                    else {
                        contextText = `vs 2024 (${formatNumber(prevVal, true)})`;
                    }
                    contextElement.textContent = contextText;
                }

                if (changeElement) {
                    if (info.isRank) {
                        const improvement = change.percent > 0 ? `Improved by ${change.percent}` : change.percent < 0 ? `Dropped by ${Math.abs(change.percent)}` : 'No Change';
                        const colorClass = change.percent > 0 ? 'text-object1-success' : change.percent < 0 ? 'text-red-600' : 'text-gray-500';
                        const iconPath = change.percent > 0 ? 'M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z' : change.percent < 0 ? 'M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 12.586V5a1 1 0 112 0v7.586l1.293-1.293a1 1 0 011.414 0z' : 'M10 18a8 8 0 100-16 8 8 0 000 16zM10 12a1 1 0 100-2 1 1 0 000 2z';
                        
                        changeElement.className = `text-xs md:text-base font-semibold mr-1 flex items-center ${colorClass}`;
                        changeElement.innerHTML = `<svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="${iconPath}" clip-rule="evenodd"></path></svg> ${improvement}`;

                    } else {
                        // Value-based metrics
                        const colorClass = change.isPositive ? 'text-object1-success' : 'text-red-600';
                        const iconPath = change.isPositive ? 'M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z' : 'M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 12.586V5a1 1 0 112 0v7.586l1.293-1.293a1 1 0 011.414 0z';
                        changeElement.className = `text-xs md:text-base font-semibold mr-1 flex items-center ${colorClass}`;
                        changeElement.innerHTML = `<svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="${iconPath}" clip-rule="evenodd"></path></svg> ${change.percent}`;
                    }
                }
            });
        }


        /**
         * Populates the three-year comparison table.
         */
        function populateComparisonTable(data) {
            const metrics = data.object1Metrics;
            const tableBody = document.getElementById('comparisonTableBody');
            tableBody.innerHTML = ''; // Clear existing rows
            
            // Calculate AvgPriceUnit on the fly
            const avgPriceUnit = [
                metrics.SalesValue[0] / metrics.Volume[0],
                metrics.SalesValue[1] / metrics.Volume[1],
                metrics.SalesValue[2] / metrics.Volume[2],
            ];

            const tableRows = [
                {
                    label: 'Total Sales Value (AED)',
                    key: 'SalesValue',
                    isCurrency: true,
                    formatValue: (v) => formatNumber(v, true)
                },
                {
                    label: 'No. of initial sale - oqood (Units)',
                    key: 'Volume',
                    isCurrency: false,
                    formatValue: (v) => formatNumber(v)
                },
                {
                    label: 'Total Built-up Area (sq ft)',
                    key: 'BuiltUpArea',
                    isCurrency: false,
                    formatValue: (v) => formatNumber(v, false, true),
                    style: 'text-purple-600'
                },
                {
                    label: 'Average sales (AED/sq ft)',
                    key: 'AvgPriceSqFt',
                    isCurrency: true,
                    formatValue: (v) => formatNumber(v, true),
                    style: 'text-pink-600'
                },
                {
                    label: 'Average Sales (AED/Unit)',
                    isCalculated: true,
                    data: avgPriceUnit,
                    isCurrency: true,
                    formatValue: (v) => formatNumber(v, true)
                },
                {
                    label: 'Total Sales Rank',
                    key: 'SalesRank',
                    isCurrency: false,
                    isRank: true,
                    formatValue: (v) => `#${v}`,
                    style: 'text-object1-primary'
                },
                {
                    label: 'Total Volume Rank',
                    key: 'VolumeRank',
                    isCurrency: false,
                    isRank: true,
                    formatValue: (v) => `#${v}`
                }
            ];

            tableRows.forEach(rowInfo => {
                const dataArray = rowInfo.isCalculated ? rowInfo.data : metrics[rowInfo.key];
                const val23 = dataArray[0];
                const val24 = dataArray[1];
                const val25 = dataArray[2];

                // Calculation for 2025 vs 2024 
                const change25_24 = rowInfo.isRank
                    ? { percent: val24 - val25, isPositive: (val24 - val25) > 0 }
                    : calculateChange(val25, val24);

                const getChangeText = (change, isRank) => {
                    if (change.percent === 'N/A') return '<span class="text-gray-500">N/A</span>';
                    
                    if (isRank) {
                        // For Rank, a positive difference means improvement
                        const improvement = change.percent > 0 ? `Improved by ${change.percent}` : change.percent < 0 ? `Dropped by ${Math.abs(change.percent)}` : 'No Change';
                        const color = change.percent > 0 ? 'text-object1-success' : change.percent < 0 ? 'text-red-600' : 'text-gray-500';
                        return `<span class="font-medium ${color}">${improvement}</span>`;
                    } else {
                        // For values, use the calculated percentage
                        const color = change.isPositive ? 'text-object1-success' : 'text-red-600';
                        return `<span class="font-medium ${color}">${change.percent}</span>`;
                    }
                };
                
                const row = tableBody.insertRow();
                row.className = 'hover:bg-indigo-50/50 transition duration-150';

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap font-semibold ${rowInfo.style || 'text-gray-800'}">${rowInfo.label}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">${rowInfo.formatValue(val23)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">${rowInfo.formatValue(val24)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right font-bold text-object1-primary">${rowInfo.formatValue(val25)}</td>
                    <!-- Change (25 vs 24) is the only change column -->
                    <td class="px-6 py-4 whitespace-nowrap text-right">${getChangeText(change25_24, rowInfo.isRank)}</td>
                `;
            });
        }

        /**
         * Initializes and renders the Chart.js charts.
         */
        function initializeCharts(data) {
            const metrics = data.object1Metrics;
            const years = data.years.map(y => y.toString());

            // 1. Destroy existing charts if they exist
            if (window.salesValueChartInstance) { window.salesValueChartInstance.destroy(); }
            if (window.locationSalesChartInstance) { window.locationSalesChartInstance.destroy(); }
            if (window.avgPriceChartInstance) { window.avgPriceChartInstance.destroy(); }

            // --- Chart 1: Sales Value Growth (Line/Bar Combo) ---
            const ctxSalesValue = document.getElementById('salesValueChart').getContext('2d');
            
            // Data for the chart: Sales Value in Billions
            const salesValueBillions = metrics.SalesValue.map(v => v / 1e9);

            window.salesValueChartInstance = new Chart(ctxSalesValue, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'Total Sales Value (AED Billion)',
                            data: salesValueBillions,
                            backgroundColor: ['rgba(79, 70, 229, 0.4)', 'rgba(79, 70, 229, 0.7)', 'rgba(79, 70, 229, 1)'],
                            borderColor: 'rgb(79, 70, 229)',
                            borderWidth: 1,
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: false },
                        legend: { display: false },
                        tooltip: { callbacks: { label: (context) => `Value: AED ${context.parsed.y.toFixed(2)} Billion` } }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            title: { display: true, text: 'Sales Value (AED Billion)' },
                            // Custom tick formatting
                            ticks: { callback: function(value, index, ticks) { return `${value.toFixed(2)} B`; } }
                        },
                        x: { 
                            title: { display: true, text: 'Year' }
                        }
                    }
                }
            });


            // --- Chart 2: Location Sales Distribution (Doughnut Chart) ---
            const locationData = data.locationSalesData;
            const ctxLocationSales = document.getElementById('locationSalesChart').getContext('2d');
            
            const chartLabels = locationData.map(d => d.location);
            const chartUnits = locationData.map(d => d.units);
            const totalUnits = chartUnits.reduce((a, b) => a + b, 0);

            // Updated, more vibrant color scheme focusing on top two locations
            const chartColors = [
                '#F97316', // Jumeirah Village Triangle (Orange - Object 1 Secondary)
                '#4f46e5', // Jumeirah Village Circle (Indigo - Object 1 Primary)
                '#10B981', // Al Satwa (Emerald)
                '#38bdf8', // Dubai Residence Complex (Sky Blue)
                '#c084fc', // Al Furjan (Violet)
                '#94a3b8', // Dubai Sports City (Slate)
            ];

            // Custom Chart.js Plugin to display center text for Doughnut chart
            const centerTextPlugin = {
                id: 'centerText',
                beforeDraw(chart) {
                    const { ctx, chartArea: { width, height } } = chart;
                    ctx.save();
                    ctx.font = 'bolder 2.5rem Inter';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = '#1f2937'; // Dark gray for visibility
                    
                    const centerX = width / 2;
                    const centerY = height / 2;

                    // Display the total unit count
                    ctx.fillText(totalUnits.toLocaleString(), centerX, centerY - 15);
                    
                    // Display the label
                    ctx.font = 'normal 1rem Inter';
                    ctx.fillStyle = '#6b7280'; // Medium gray
                    ctx.fillText('Total Units Sold', centerX, centerY + 25);

                    ctx.restore();
                }
            };


            window.locationSalesChartInstance = new Chart(ctxLocationSales, {
                type: 'doughnut', // Changed to Doughnut
                data: {
                    labels: chartLabels,
                    datasets: [{
                        data: chartUnits,
                        backgroundColor: chartColors,
                        hoverOffset: 15,
                        borderColor: '#ffffff',
                        borderWidth: 4, // Increased border for better separation
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%', // Added cutout for doughnut shape
                    plugins: {
                        legend: { 
                            position: 'right', 
                            labels: {
                                font: { family: 'Inter', size: 14 },
                                padding: 25,
                                boxWidth: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1) + '%';
                                    return ` ${context.label}: ${value.toLocaleString()} Units (${percentage})`;
                                }
                            }
                        }
                    }
                },
                plugins: [centerTextPlugin] // Apply the custom plugin
            });


            // --- Chart 3: Market Positioning (Avg Price Per Sq Ft 2025) ---
            const developerData = data.developerComparisonData;
            const object1Data = { "Name": "Object 1", "AvgPricePerSqFt2025": metrics.AvgPriceSqFt[2] };
            
            // Add Object 1 to the comparison data if it's not already there (prevents duplicates)
            let obj1Index = developerData.findIndex(d => d.Name === 'Object 1');
            if (obj1Index === -1) {
                 developerData.push(object1Data);
            } else {
                 // Ensure Object 1 data is updated if it was a placeholder
                 developerData[obj1Index] = object1Data;
            }

            // Sort by AvgPricePerSqFt2025 to create a structured bar chart (Descending)
            developerData.sort((a, b) => b.AvgPricePerSqFt2025 - a.AvgPricePerSqFt2025);

            const chartLabelsAvgPrice = developerData.map(d => d.Name);
            const avgPricePerSqFt2025 = developerData.map(d => d.AvgPricePerSqFt2025);

            const ctxAvgPrice = document.getElementById('avgPriceChart').getContext('2d');
            
            window.avgPriceChartInstance = new Chart(ctxAvgPrice, {
                type: 'bar',
                data: {
                    labels: chartLabelsAvgPrice,
                    datasets: [
                        {
                            label: 'Avg. Price Per Sq Ft (AED)',
                            data: avgPricePerSqFt2025,
                            backgroundColor: chartLabelsAvgPrice.map(name => name === 'Object 1' ? 'rgba(249, 115, 22, 0.9)' : 'rgba(16, 185, 129, 0.6)'), // Orange for Object 1, Green for others
                            borderColor: chartLabelsAvgPrice.map(name => name === 'Object 1' ? 'rgba(249, 115, 22, 1)' : 'rgba(16, 185, 129, 1)'),
                            borderWidth: 1,
                            borderRadius: 8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', // Horizontal bars for better label reading
                    plugins: {
                        title: { display: false },
                        legend: { display: false },
                        tooltip: { callbacks: { label: (context) => `${context.dataset.label}: AED ${context.parsed.x.toLocaleString()}` } }
                    },
                    scales: {
                        x: { 
                            beginAtZero: true, 
                            title: { display: true, text: 'Price (AED/sq ft)' },
                            // Custom tick formatting for price
                            ticks: { callback: function(value, index, ticks) { return value.toLocaleString(); } }
                        },
                        y: { 
                            ticks: { 
                                autoSkip: false
                            } 
                        }
                    }
                }
            });
        }
        
        window.onload = function() {
            try {
                // Populate the snapshot cards first
                populateSnapshotCards(infographicData);
                // Populate the three-year table
                populateComparisonTable(infographicData);
                // Initialize all charts
                initializeCharts(infographicData);
            } catch (e) {
                // Display error message gracefully
                document.getElementById('app-container').innerHTML = '<div class="text-red-600 p-8 text-center bg-white rounded-xl shadow-lg mt-10">Error: Could not load or process chart data. Please check the integrity of the provided data structure.</div>';
                console.error("Error initializing app:", e);
            }
        };
    </script>
</body>
</html>
